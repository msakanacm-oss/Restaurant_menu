<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Menu</title>
<style>
  html {
  scroll-behavior: smooth;
}
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; background:#111; color:#fff; }
  h1 { text-align:center; padding:18px 0; margin:0; letter-spacing:0.08em; }
  .notice{
  padding: 0 16px 10px;
  color: #aaa;
  font-size: 13px;
  line-height: 1.4;
}
  section { padding:0 16px; }
  h2 { margin:28px 0 10px; padding-bottom:6px; border-bottom:1px solid #333; font-size:18px; }
  .card { display:flex; gap:12px; padding:12px 0; border-bottom:1px solid #222; align-items:center; }
  .card img { width:92px; height:92px; border-radius:10px; object-fit:cover; background:#222; }
  .meta { flex:1; min-width:0; }
  .name { font-size:16px; font-weight:700; }
  .price { margin-top:4px; font-size:15px; }
  .desc { margin-top:6px; font-size:13px; color:#aaa; line-height:1.35; white-space:pre-wrap; }
  .muted { color:#aaa; padding:0 16px 20px; }
  #category-nav {
  position: sticky;
  top: 0;
  background: #111;
  padding: 10px 10px 5px;
  display: flex;
  gap: 10px;
  overflow-x: auto;
  border-bottom: 1px solid #333;
  z-index: 1000;
}

#category-nav a {
  color: #fff;
  text-decoration: none;
  font-size: 16px;
  padding: 8px 12px;
  border: 1px solid #444;
  border-radius: 20px;
  white-space: nowrap;
}

#category-nav a:hover {
  background: #333;
}

</style>
</head>
<body>
<div id="category-nav"></div>
<h1>MENU</h1>
  <div class="notice">
  ※表示価格はすべて税込です。<br>
  ※お水をご注文の場合は、100円で飲み放題です（不要な方には頂戴しません）。
</div>
<div id="menu" class="muted">Loading...</div>

<script>
/** ここにあなたの「公開CSV URL」を貼る */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGxN8YgKwNRIYis1xPoDaMKNR0rURaMG6Lm9Gx85r0_dKVxeiFnLgyS8dxJ6rlIwru0HrrrbzyU06E/pub?gid=0&single=true&output=csv";

/** カテゴリ順（指定どおり固定） */
const CATEGORY_ORDER = ["ビール","スパークリング","赤ワイン","白ワイン","ロゼ","シェリー","フード"];
const orderIndex = Object.fromEntries(CATEGORY_ORDER.map((c,i)=>[c,i]));

/** CSVパーサ（ダブルクォート/カンマ/改行に対応） */
function parseCSV(text){
  const rows = [];
  let row = [], field = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i+1];

    if (inQuotes) {
      if (c === '"' && next === '"') { field += '"'; i++; }
      else if (c === '"') { inQuotes = false; }
      else { field += c; }
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ',') { row.push(field); field = ""; }
      else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ""; }
      else if (c === '\r') { /* ignore */ }
      else { field += c; }
    }
  }
  // last field
  row.push(field);
  rows.push(row);

  // 末尾の空行除去
  return rows.filter(r => r.some(x => String(x).trim() !== ""));
}

function toBool(s){
  const v = String(s ?? "").trim().toLowerCase();
  return v === "true" || v === "1" || v === "yes" || v === "y";
}
function toNum(s){
  const v = String(s ?? "").replace(/[^\d.-]/g, "");
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function toImageUrl(image_id, image_url){
  const id = String(image_id ?? "").trim();
  if(id) return "https://lh3.googleusercontent.com/d/" + encodeURIComponent(id);
  const url = String(image_url ?? "").trim();
  return url; // 互換：旧image_urlが残っていても表示できる
}

async function main(){
  const root = document.getElementById("menu");

  try{
    // 毎日更新なのでキャッシュ回避
    const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url);
    if(!res.ok) throw new Error("HTTP " + res.status);
    const csvText = await res.text();

    const rows = parseCSV(csvText);
    if(rows.length < 2) throw new Error("CSV is empty");

    const headers = rows[0].map(h => String(h).trim());
    const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));

    // 必須列チェック（不足しても落とさず動かす）
    const col = (name) => idx[name];

    const items = rows.slice(1)
      .map(r => ({
        sort: toNum(r[col("sort")]),
        category: String(r[col("category")] ?? "").trim(),
        name: String(r[col("name")] ?? "").trim(),
        price_yen: toNum(r[col("price_yen")]),
        desc: String(r[col("desc")] ?? "").trim(),
        image_id: String(r[col("image_id")] ?? "").trim(),
        image_url: String(r[col("image_url")] ?? "").trim(),
        available: toBool(r[col("available")]),
      }))
      .filter(x => x.available)
      .filter(x => x.category && x.name);

    // カテゴリごとにまとめる
    const grouped = {};
    for (const c of CATEGORY_ORDER) grouped[c] = [];
    for (const it of items) {
      if (!grouped[it.category]) grouped[it.category] = [];
      grouped[it.category].push(it);
    }

    // カテゴリ順（未定義カテゴリは末尾）
    const categories = Object.keys(grouped).sort((a,b) => (orderIndex[a] ?? 999) - (orderIndex[b] ?? 999));

    // 描画
    root.className = "";
    root.innerHTML = "";

    const nav = document.getElementById("category-nav");
nav.innerHTML = "";

categories.forEach(cat => {
  const link = document.createElement("a");
  link.href = "#" + cat;
  link.textContent = cat;
  nav.appendChild(link);
});


    categories.forEach(cat => {
      const list = grouped[cat] || [];
      // 全空カテゴリは出さない（見た目スッキリ）
      if(list.length === 0) return;

      list.sort((a,b) => (a.sort ?? 9999) - (b.sort ?? 9999));

      const section = document.createElement("section");
      section.id = cat;
      section.innerHTML = `<h2>${esc(cat)}</h2>`
      root.appendChild(section);

      list.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

  //       const imgHtml = item.image_url
     //      ? `<img src="${item.image_url.trim()}" alt="${esc(item.name)}" loading="lazy">`
     //      : `<img alt="" loading="lazy">`;
        const imgSrc = toImageUrl(item.image_id, item.image_url);

        const imgHtml = imgSrc
        ? `<img src="${imgSrc}" alt="${esc(item.name)}" loading="lazy">`
        : `<img alt="" loading="lazy">`;


        card.innerHTML = `
          ${imgHtml}
          <div class="meta">
            <div class="name">${esc(item.name)}</div>
            <div class="price">¥${Number(item.price_yen).toLocaleString("ja-JP")}</div>
            <div class="desc">${esc(item.desc)}</div>
          </div>
        `;
        section.appendChild(card);
      });
    });

    if(root.innerHTML.trim() === ""){
      root.className = "muted";
      root.textContent = "現在提供中のメニューがありません";
    }

  }catch(e){
    root.className = "muted";
    root.textContent = "Menu load error: " + e;
    console.error(e);
  }
}

main();
</script>
</body>
</html>
